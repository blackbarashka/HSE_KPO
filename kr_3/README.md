# Контрольная работа 3. Мусаев Умахан Рашидович


## Описание

Проект реализует интернет-магазин с микросервисной архитектурой, рассчитанный на работу в условиях высокой нагрузки (например, сезонные распродажи). Основной акцент — надежность, масштабируемость и отказоустойчивость процессов создания заказа и оплаты.

---

## Архитектура

- **API Gateway** — единая точка входа, маршрутизация REST-запросов к микросервисам.
- **Orders Service** — управление заказами: создание, просмотр списка, просмотр статуса.
- **Payments Service** — управление счетами: создание счета, пополнение, просмотр баланса, обработка платежей.
- **WebUI** — фронтенд на Razor Pages, взаимодействует с API Gateway.
- **RabbitMQ** — брокер сообщений для асинхронного взаимодействия между сервисами.
- **PostgreSQL** — база данных для Orders и Payments сервисов.
- **Docker/Docker Compose** — контейнеризация и оркестрация всех компонентов.

---

## Используемые технологии

- **.NET 8**, **ASP.NET Core**, **Razor Pages**
- **Entity Framework Core**
- **SignalR** (WebSocket-уведомления о статусе заказа)
- **RabbitMQ** (очереди сообщений)
- **PostgreSQL** (хранение данных)
- **Docker**, **Docker Compose**
- **Swagger** (автоматическая документация API)
- **xUnit**, **Moq**, **FluentAssertions** (тестирование)

---

## Как выполнены требования ТЗ
## **Реализованы все требования ТЗ, включая push-уведомления и фронтенд.**
### 1. Функциональность

- **Payments Service**:
  - Создание счета (один на пользователя)
  - Пополнение счета
  - Просмотр баланса
- **Orders Service**:
  - Создание заказа (асинхронно инициирует оплату через очередь)
  - Просмотр списка заказов пользователя
  - Просмотр статуса заказа

### 2. Архитектурные решения

- **Четкое разделение сервисов**: каждый сервис отвечает только за свою предметную область.
- **Очереди сообщений**: RabbitMQ для асинхронной связи между Orders и Payments.
- **Паттерны**:
  - Transactional Outbox (Orders Service)
  - Transactional Inbox и Outbox (Payments Service)
  - Exactly-once семантика при списании денег (идемпотентность через InboxMessage)
- **Гарантии доставки**: сообщения не теряются, не дублируются, не обрабатываются дважды.
- **Атомарность операций**: транзакции и блокировки на уровне БД, предотвращение гонок при пополнении/списании.

### 3. Документация API

- Swagger UI доступен через API Gateway (`/swagger`), описывает все эндпоинты и сценарии.

### 4. Покрытие тестами

- Покрытие тестами (xUnit) > 65% для Orders и Payments сервисов.
- Тестируются бизнес-логика, сценарии ошибок, интеграция с очередями.

### 5. Docker и запуск

- Каждый сервис — отдельный Docker-контейнер.
- `docker-compose.yml` разворачивает всю систему одной командой.
- После запуска все сервисы доступны и готовы к работе.

### 6. Фронтенд

- WebUI на Razor Pages, отдельный сервис.
- Взаимодействие с бэкендом через REST API.
- Упакован в Docker, запускается через Compose.

### 7. WebSocket-уведомления

- SignalR (Orders Service) — push-уведомления о смене статуса заказа.
- WebUI подключается к SignalR и отображает уведомления пользователю.

---

## Как запустить проект

1. **Запустите Docker Desktop**
2.  **Запустите все сервисы:**
    `docker-compose up --build`

## **Доступы:**
- WebUI: [http://localhost:8080](http://localhost:8080)
- Swagger (API Gateway): [http://localhost:8000/swagger](http://localhost:8000/swagger)
- RabbitMQ: [http://localhost:15672](http://localhost:15672) (логин/пароль: guest/guest)

   
---

## Тестирование и покрытие

- Запуск тестов:
  `dotnet test`



---
## Пример работы:

## Фронтенд:
### Главная страница:

![image](https://github.com/user-attachments/assets/e17b918c-2be5-4112-98e2-4594a1f50d06)

### Управление счетом: 

![image](https://github.com/user-attachments/assets/38736eed-371b-4316-aaf1-803448d5a05b)

![image](https://github.com/user-attachments/assets/6913f1d9-fb9d-4d46-a796-772e9b386faa)


### Заказы:

![image](https://github.com/user-attachments/assets/182d224d-66b4-4f0c-a59e-4bc094246a60)

### Детали заказа:

![image](https://github.com/user-attachments/assets/9fc16efa-6660-405e-b7aa-632668d6608f)

## Swagger:

### Регестрируемся (вводим X-User-Id):

![image](https://github.com/user-attachments/assets/5a4b5844-3c98-4dee-8b8e-bc1d405749a0)

### Весь функционал реализован:

![image](https://github.com/user-attachments/assets/1cf802db-43eb-4f70-866a-588be274d649)


## Статус заказа:

ВНИМАНИЕ: **Если стоимость заказа больше чем баланс пользователя, то заказ не выполнится.**

![image](https://github.com/user-attachments/assets/0a367fb7-dc56-497b-be27-8dcb14d1c748)

После обновления сайта через 5 секунд, статус заказа меняется:

1. ![image](https://github.com/user-attachments/assets/5f862994-a484-43cc-a251-85bfae72a2c4)

2. ![image](https://github.com/user-attachments/assets/5a32678f-b451-4bc8-97d3-653b3cd3d345)



